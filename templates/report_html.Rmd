---
title: "Report generated by the acbench package"
output: 
  html_document:
    toc: true
    highlight: pygments
    toc_float: true
---
```{css, echo=FALSE}
pre {
  white-space:pre !important;
  overflow-x: auto;
  max-width: 100%;
}
pre code {
  white-space:pre !important;
  overflow-x: auto;
}
.overflow {
  white-space:pre !important;
  overflow-x: auto;
  max-width: 100%;
}
```

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include= FALSE}
library(ggplot2)
library(data.table, quietly = TRUE)
library(DT)
if (!exists("interactive_plots")) interactive_plots <- base::interactive()
# FIXME: Move show_table to the package so people can use it to create their
# own reports.
show_table <- function(x, row.names = FALSE, search = FALSE, lengthMenu = NULL,
                       searchHighlight = TRUE, dom='Blrtip', colorbar = NULL, style = list(), ...) {

  if (!interactive_plots) return(knitr::kable(x, row.names = row.names))

  if (search) dom <- sub("r", "fr", dom, fixed = TRUE)
  if (is.null(lengthMenu)) {
    pageLength <- NULL
  } else {
    pageLength <- lengthMenu[1]
    if (nrow(x) <= pageLength) dom <- gsub("[lip]", "", dom) # autoHideNavigation
  }
  columnDefs <- list(list(className = 'dt-right', targets = "_all"))
  tab <- DT::datatable(x, rownames = row.names,
                       class = 'compact row-border hover',
                       autoHideNavigation = TRUE,
                       extensions = c('Buttons', 'KeyTable'),
                       options = list(
                         keys = TRUE,
                         searchHighlight = search,
                         scrollX = TRUE,
                         pageLength=pageLength,
                         lengthMenu = lengthMenu,
                         dom = dom,
                         buttons = c('copy', 'csv'), #, 'colvis'),
                         columnDefs = columnDefs)) %>% DT::formatStyle(colnames(x), fontSize='85%')
  for (col in colorbar) {
    if(!(col %in% colnames(x)))
      stop("Column ", col, " not found in table: ", paste0(colnames(x), collapse=", "))
    if (all(is.na(x[, col]))) next # Don't add colorbar if all are NA.
    tab <- DT::formatStyle(tab, columns = col,
                           background = DT::styleColorBar(range(x[, col], na.rm=TRUE), 'lightblue'),
                           backgroundSize = '98% 88%',
                           backgroundRepeat = 'no-repeat',
                           backgroundPosition = 'center')
  }
  for (s in style) {
    tab <- do.call(DT::formatStyle, c(table=tab, s))
  }
  tab
}
readRDS_safe <- function(filename) {
  if (!fs::file_exists(filename))
    cli_abort("'{.file {filename}} does not exist")
  readRDS(filename)
}

dt <- readRDS_safe(file.path(path, "train_results.rds"))

# TODO, exclude columns like rep.
my_summary <- function(x) list(mean=mean(x), sd=sd(x))
train_summary <- dt[, as.list(unlist(lapply(.SD, length))), by = c("scenario", "tuner"), .SDcols="rep"]
train_summary <- train_summary[
  dt[, as.list(unlist(lapply(.SD, my_summary))), by = c("scenario", "tuner"), .SDcols = setdiff(colnames(dt), c("scenario", "tuner", "rep"))],
  on = c("scenario", "tuner")]

test_res <- readRDS_safe(file.path(path, "test_results.rds"))

```

# Training results

```{r train_summary,fig.align="center", echo=FALSE}
show_table(train_summary, lengthMenu = c(20, 50, 100))
```

## Boxplot

```{r train-boxplot,fig.align="center", out.width="100%", echo=FALSE}
id_vars <- c("scenario", "tuner", "rep")
num_cols <- setdiff(colnames(dt), id_vars)
dt[, (num_cols):=lapply(.SD, as.numeric), .SDcols=num_cols]
dt <- melt(dt, id.vars = id_vars)
ggplot(dt, aes(x=value, y=scenario, fill=tuner)) +
  geom_boxplot() + facet_wrap(~variable, scales="free_x")
```

# Testing results

```{r test_summary,fig.align="center", echo=FALSE}
tabcost <- rbindlist(lapply(test_res, `[`, j = c("scenario", "tuner", "rep", "cost", "instance"), with = FALSE))
tabcost[, rank_cost := rank(cost), by= list(scenario, instance)]
tabsum <- tabcost[, list(cost_mean = mean(cost), cost_sd = sd(cost),
                         cost_mean_rank = mean(rank_cost), cost_sd_rank = sd(rank_cost)),
                  by=list(scenario, tuner)]
show_table(tabsum, lengthMenu = c(20, 50, 100))
```

## Boxplot 
```{r test-boxplot,fig.align="center", out.width="100%", echo=FALSE}
ggplot(tabcost, aes(x=cost, y=tuner)) + 
  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75)) + facet_wrap(~scenario, scales="free_x")
```

## Boxplot (by ranks)

```{r test-boxplot-ranks,fig.align="center", out.width="100%", echo=FALSE}
ggplot(tabcost, aes(x=cost, y=tuner)) + 
  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75)) + facet_wrap(~scenario, scales="free_x")
```

## Test results per repetition

```{r, results = "asis", echo = FALSE}
for (scenario in names(test_res)) {
  res <- test_res[[scenario]]
  res$rep <- as.factor(res$rep)
  cat(sprintf("\n\n### Scenario `%s` \n\n", scenario))
  print(ggplot(res, aes(x=tuner, y=cost, color=rep)) + geom_violin(draw_quantiles = c(0.25, 0.5, 0.75))) #+ geom_jitter(alpha=.75))
        #position = position_jitter(seed = 1, width = 0.2), alpha=0.75) + theme(legend.position = "none"))
}
```

